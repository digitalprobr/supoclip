services:
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: development
    container_name: supoclip-frontend
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/prisma:/app/prisma
    environment:
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - DATABASE_URL=${DATABASE_URL}
      - BETTER_AUTH_SECRET=${BETTER_AUTH_SECRET}
      - BETTER_AUTH_URL=${BETTER_AUTH_URL}
    depends_on:
      - backend
    restart: unless-stopped

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    container_name: supoclip-backend
    platform: linux/amd64
    working_dir: /app
    # TENTATIVA 1: main.py ao inv√©s de main_refactored.py
    command: ["sh", "-c", "cd /app && ls -la src/ && .venv/bin/python -m uvicorn main:app --host 0.0.0.0 --port 8000 --reload"]
    ports:
      - "8081:8000"
    volumes:
      - ./backend:/app
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=${DATABASE_URL}
      - TEMP_DIR=/app/uploads
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ASSEMBLY_AI_API_KEY=${ASSEMBLY_AI_API_KEY}
      - LLM=${LLM:-openai:gpt-4}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - WHISPER_MODEL_SIZE=${WHISPER_MODEL_SIZE:-medium}
    restart: unless-stopped
    depends_on:
      - redis

  worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
      platforms:
        - linux/amd64
    container_name: supoclip-worker
    platform: linux/amd64
    working_dir: /app
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    command: ["sh", "-c", "cd /app && .venv/bin/python -m arq src.workers.tasks.WorkerSettings"]
    volumes:
      - ./backend:/app
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=${DATABASE_URL}
      - TEMP_DIR=/app/uploads
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ASSEMBLY_AI_API_KEY=${ASSEMBLY_AI_API_KEY}
      - LLM=${LLM:-openai:gpt-4}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - WHISPER_MODEL_SIZE=${WHISPER_MODEL_SIZE:-medium}
    restart: unless-stopped
    depends_on:
      - redis
      - backend

  redis:
    image: redis:7.4-alpine
    container_name: supoclip-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  uploads:
    driver: local
  clips:
    driver: local
  redis_data:
    driver: local

networks:
  default:
    name: supoclip-network
